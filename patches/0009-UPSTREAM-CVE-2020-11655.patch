From e3d945d12a06f11ee54f8612c32ed465beee074a Mon Sep 17 00:00:00 2001
From: "Vladimir D. Seleznev" <vseleznv@altlinux.org>
Date: Tue, 19 May 2020 15:49:54 +0300
Subject: [PATCH 9/9] UPSTREAM: CVE-2020-11655

https://www3.sqlite.org/cgi/src/info/4a302b42c7bf5e11
---
 sqlite/src/select.c      | 1 +
 sqlite/test/window1.test | 9 +++++++++
 2 files changed, 10 insertions(+)

diff --git a/sqlite/src/select.c b/sqlite/src/select.c
index dbf19f7ad..501796547 100644
--- a/sqlite/src/select.c
+++ b/sqlite/src/select.c
@@ -5348,6 +5348,7 @@ static void resetAccumulator(Parse *pParse, AggInfo *pAggInfo){
   struct AggInfo_func *pFunc;
   int nReg = pAggInfo->nFunc + pAggInfo->nColumn;
   if( nReg==0 ) return;
+  if( pParse->nErr ) return;
 #ifdef SQLITE_DEBUG
   /* Verify that all AggInfo registers are within the range specified by
   ** AggInfo.mnReg..AggInfo.mxReg */
diff --git a/sqlite/test/window1.test b/sqlite/test/window1.test
index 833e211fb..18b9bdcce 100644
--- a/sqlite/test/window1.test
+++ b/sqlite/test/window1.test
@@ -1593,5 +1593,14 @@ do_execsql_test 48.1 {
     FROM (SELECT (SELECT sum(a) FROM t1 GROUP BY a) AS x FROM t1);
 } {2 2 2}
 
+# 2020-04-03 ticket af4556bb5c285c08
+#
+reset_db
+do_catchsql_test 51.1 {
+  CREATE TABLE a(b, c);
+  SELECT c FROM a GROUP BY c
+    HAVING(SELECT(sum(b) OVER(ORDER BY b),
+                  sum(b) OVER(PARTITION BY min(DISTINCT c), c ORDER BY b)));
+} {1 {row value misused}}
 
 finish_test
-- 
2.25.4

