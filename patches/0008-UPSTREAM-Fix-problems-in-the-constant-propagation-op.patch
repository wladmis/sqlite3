From ae9e1f8429de05a1368406bad8c51987186c314c Mon Sep 17 00:00:00 2001
From: "Vladimir D. Seleznev" <vseleznv@altlinux.org>
Date: Tue, 19 May 2020 15:55:00 +0300
Subject: [PATCH 8/9] UPSTREAM: Fix problems in the constant propagation
 optimization

https://www.sqlite.org/src/info/c9a8defcef35a1fe
---
 sqlite/src/select.c     |  8 ++------
 sqlite/test/whereL.test | 12 ++++++++++++
 2 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/sqlite/src/select.c b/sqlite/src/select.c
index 595b6eb6b..dbf19f7ad 100644
--- a/sqlite/src/select.c
+++ b/sqlite/src/select.c
@@ -4166,9 +4166,8 @@ static void constInsert(
   assert( pColumn->op==TK_COLUMN );
   assert( sqlite3ExprIsConstant(pValue) );
 
-  if( !ExprHasProperty(pValue, EP_FixedCol) && sqlite3ExprAffinity(pValue)!=0 ){
-    return;
-  }
+  if( ExprHasProperty(pColumn, EP_FixedCol) ) return;
+  if( sqlite3ExprAffinity(pValue)!=0 ) return;
   if( !sqlite3IsBinary(sqlite3ExprCompareCollSeq(pConst->pParse,pExpr)) ){
     return;
   }
@@ -4191,9 +4190,6 @@ static void constInsert(
   if( pConst->apExpr==0 ){
     pConst->nConst = 0;
   }else{
-    if( ExprHasProperty(pValue, EP_FixedCol) ){
-      pValue = pValue->pLeft;
-    }
     pConst->apExpr[pConst->nConst*2-2] = pColumn;
     pConst->apExpr[pConst->nConst*2-1] = pValue;
   }
diff --git a/sqlite/test/whereL.test b/sqlite/test/whereL.test
index bd2f56160..0f577e06e 100644
--- a/sqlite/test/whereL.test
+++ b/sqlite/test/whereL.test
@@ -144,5 +144,17 @@ do_execsql_test 530 {
   SELECT 200, * FROM t0, v0 WHERE t0.c0 = 0 AND v0.c0 = t0.c0;
 } {}
 
+# 2020-02-13: ticket 1dcb4d44964846ad
+# A problem introduced while making optimizations on the fixes above.
+#
+reset_db
+do_execsql_test 600 {
+  CREATE TABLE t1(x TEXT);
+  CREATE TABLE t2(y TEXT);
+  INSERT INTO t1 VALUES('good'),('bad');
+  INSERT INTO t2 VALUES('good'),('bad');
+  SELECT * FROM t1 JOIN t2 ON x=y
+   WHERE x='good' AND y='good';
+} {good good}
 
 finish_test
-- 
2.25.4

